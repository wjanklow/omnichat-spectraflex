<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Omnichat Client</title>

  <!-- ðŸ‘‡ ZERO-CACHE so updates show instantly -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma"        content="no-cache">
  <meta http-equiv="Expires"       content="0">

  <style>
  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ base layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  :root {
    --blue: #007aff;
    --grey: #e5e5ea;
  }
  html,body { height:100%; margin:0; font-family:-apple-system,BlinkMacSystemFont,sans-serif; }

  /* widget container (set your own width/position in parent site) */
  .chatbox {
    width: 340px; max-height: 90vh;
    display:flex; flex-direction:column;
    background:#fff; border-radius:14px;
    box-shadow:0 6px 18px rgba(0,0,0,.15);
    overflow:hidden;
  }

  /* message log */
  #log {
    flex:1 1 auto; padding:12px 14px; overflow-y:auto;
    display:flex; flex-direction:column; gap:10px;
    background:#fafafa;
    scroll-behavior:smooth;
  }
  /* sleek scrollbar */
  #log::-webkit-scrollbar { width:6px; }
  #log::-webkit-scrollbar-thumb { background:#ccc; border-radius:3px; }
  #log { scrollbar-width:thin; scrollbar-color:#ccc transparent; }

  /* input bar */
  #frm {
    flex:0 0 auto; display:flex; gap:10px;
    padding:10px 14px; background:#fff; border-top:1px solid #e0e0e0;
  }
  #msg {
    flex:1; font-size:15px;
    padding:10px 14px; border:1px solid #d0d0d0; border-radius:20px;
    outline:none;
  }

  /* bubbles */
  .bubble {
    max-width:78%; padding:10px 14px; border-radius:20px;
    line-height:1.35; word-break:break-word; white-space:pre-wrap;
  }
  .bot  { background:var(--grey);  color:#000;
          align-self:flex-start; border-bottom-left-radius:6px; }
  .user { background:var(--blue); color:#fff;
          align-self:flex-end;   border-bottom-right-radius:6px; }

  /* links in bubbles */
  .bubble a { color:inherit; text-decoration:underline; }
  </style>
</head>

<body>
  <div class="chatbox">
    <div id="log"></div>

    <form id="frm">
      <input id="msg" autocomplete="off" placeholder="Ask a questionâ€¦">
    </form>
  </div>

  <script>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1. helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const SESSION_KEY = "spectraflex_chat_session";
let session = localStorage.getItem(SESSION_KEY) || null;

function escapeHtml(str){
  return str.replace(/[&<>]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]));
}
function linkify(str){
  str = str.replace(/\[([^\]]+)]\((https?:\/\/[^\s)]+)\)/g,
                    (_, lbl,url)=>`<a href="${url}" target="_blank" rel="noopener">${lbl}</a>`);
  return str.replace(/(https?:\/\/[^\s]+)/g,
                    url=>`<a href="${url}" target="_blank" rel="noopener">${url}</a>`);
}
function addBubble(role, html){
  const div = document.createElement("div");
  div.className = `bubble ${role}`;
  div.innerHTML = html;
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2. WebSocket setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const WS_URL = decodeURIComponent(
  new URLSearchParams(location.search).get("ws") ||
  "wss://omnichat-spectraflex.onrender.com/ws"
);
const ws  = new WebSocket(WS_URL);
const log = document.getElementById("log");

ws.onopen  = () => console.log("[WS] open â†’", WS_URL);
ws.onclose = e  => console.log("[WS] closed", e.code, e.reason);
ws.onerror = e  => console.error("[WS] error", e);

ws.onmessage = e => {
  const d = JSON.parse(e.data);          // { session, answer }

  if (d.session && !session){
    session = d.session;
    localStorage.setItem(SESSION_KEY, session);
  }
  addBubble("bot", linkify(escapeHtml(d.answer)));
};

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 3. send form handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.getElementById("frm").onsubmit = e => {
  e.preventDefault();
  const val = msg.value.trim();
  if (!val || ws.readyState !== WebSocket.OPEN) return;

  ws.send(JSON.stringify({
    session,
    message: val,
    product: window.__CURRENT_PRODUCT_HANDLE__ || null
  }));

  addBubble("user", linkify(escapeHtml(val)));
  msg.value = "";
};
  </script>
</body>
</html>
