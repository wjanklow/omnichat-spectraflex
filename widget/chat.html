<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Omnichat Debug Client</title>

  <style>
    /* ── layout basics ────────────────────────────────────────────── */
    body { margin:0; font-family:-apple-system,BlinkMacSystemFont,sans-serif; }

    /* message log: flex column so bubbles self-align left/right */
    #log  {
      height:90vh; overflow:auto; padding:16px;
      display:flex; flex-direction:column; gap:8px;
      background:#fafafa; font-size:15px;
    }

    /* bottom input bar */
    #frm  {
      display:flex; padding:12px 16px;
      border-top:1px solid #e5e5e5; background:#fff;
    }
    #msg  {
      flex:1; border:1px solid #ccc; border-radius:20px;
      padding:10px 14px; font-size:15px;
    }

    /* ── chat bubbles à la iMessage ──────────────────────────────── */
    .bubble {
      max-width:80%; padding:10px 14px; border-radius:20px;
      line-height:1.35; word-break:break-word;
    }
    .bot  { background:#e5e5ea; color:#000;
            align-self:flex-start; border-bottom-left-radius:4px; }
    .user { background:#007aff; color:#fff;
            align-self:flex-end;   border-bottom-right-radius:4px; }

    /* links stay legible inside bubbles */
    a { color:inherit; text-decoration:underline; }
  </style>
</head>

<body>
  <div id="log"></div>

  <form id="frm">
    <input id="msg" autocomplete="off" placeholder="Ask a question…">
  </form>

  <script>
/* ────────────────────────────────────────────────────────────────────────── */
/* 1.  Startup constants & helpers                                           */
/* ────────────────────────────────────────────────────────────────────────── */
const SESSION_KEY = "spectraflex_chat_session";

/* restore any previous session-id saved in localStorage */
let session = localStorage.getItem(SESSION_KEY) || null;

/** escape <, >, & before we inject HTML */
function escapeHtml(str){
  return str.replace(/[&<>]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]));
}

/** Turn Markdown links *and* bare URLs into clickable <a> tags */
function linkify(str){
  /* 1 . [label](https://link) */
  str = str.replace(
    /\[([^\]]+)]\((https?:\/\/[^\s)]+)\)/g,
    (_, label, url) => `<a href="${url}" target="_blank" rel="noopener">${label}</a>`
  );
  /* 2 . bare https://link */
  return str.replace(
    /(https?:\/\/[^\s]+)/g,
    url => `<a href="${url}" target="_blank" rel="noopener">${url}</a>`
  );
}

/** add a left- or right-aligned bubble to the log */
function addBubble(role, html){
  const div = document.createElement("div");
  div.className = `bubble ${role}`;
  div.innerHTML = html;
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
}

/* ────────────────────────────────────────────────────────────────────────── */
/* 2.  WebSocket                                                             */
/* ────────────────────────────────────────────────────────────────────────── */
const WS_URL = decodeURIComponent(
  new URLSearchParams(location.search).get("ws") ||
  "wss://omnichat-spectraflex.onrender.com/ws"   // fallback when no ?ws=…
);

const ws  = new WebSocket(WS_URL);
const log = document.getElementById("log");

ws.onopen  = () => console.log("[WS] open →", WS_URL);
ws.onclose = e  => console.log("[WS] closed", e.code, e.reason);
ws.onerror = e  => console.error("[WS] error", e);

/* incoming messages ------------------------------------------------------- */
ws.onmessage = e => {
  const d = JSON.parse(e.data);          // expects { session, answer }

  /* remember the session-id the first time the backend sends it */
  if (d.session && !session){
    session = d.session;
    localStorage.setItem(SESSION_KEY, session);
  }

  addBubble("bot", linkify(escapeHtml(d.answer)));
};

/* ────────────────────────────────────────────────────────────────────────── */
/* 3.  Form submit ↠ send message                                            */
/* ────────────────────────────────────────────────────────────────────────── */
document.getElementById("frm").onsubmit = e => {
  e.preventDefault();
  const val = msg.value.trim();
  if (!val || ws.readyState !== WebSocket.OPEN) return;

  ws.send(JSON.stringify({
    session,                             // may be null on first send
    message: val,
    product: window.__CURRENT_PRODUCT_HANDLE__ || null
  }));

  addBubble("user", linkify(escapeHtml(val)));
  msg.value = "";
};
  </script>
</body>
</html>
