<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Omnichat Client</title>

  <!-- disable caching so edits show immediately -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma"        content="no-cache">
  <meta http-equiv="Expires"       content="0">

  <style>
  /* ───────── base palette ──────────────────────────────── */
  :root{
    --blue: #007aff;           /* iMessage blue                */
    --grey: #e5e5ea;           /* iMessage grey                */
    --bg:   #fafafa;           /* chat body background         */
    --radius: 20px;            /* bubble corner radius         */
  }

  html,body{
    height:100%; margin:0;
    font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif;
    background:var(--bg);
  }

  /* ───────── widget container ──────────────────────────── */
  .chatbox{
    height:100%;               /* iframe dictates width/height */
    width:100%;
    display:flex; flex-direction:column;
    background:#fff; border-radius:14px;
    overflow:hidden;
  }

  /* ───────── message log ───────────────────────────────── */
  #log{
    flex:1 1 auto;
    padding:16px 18px;         /* space around bubbles         */
    overflow-y:auto;
    display:flex; flex-direction:column; gap:12px;
    scroll-behavior:smooth;
  }

  /* custom scrollbar (WebKit) */
  #log::-webkit-scrollbar        { width:6px; }
  #log::-webkit-scrollbar-thumb  { background:#ccc; border-radius:3px; }
  /* Firefox scrollbar */
  #log{ scrollbar-width:thin; scrollbar-color:#ccc transparent; }

  /* ───────── input bar ─────────────────────────────────── */
  #frm{
    flex:0 0 auto;
    display:flex; gap:10px;
    padding:14px 18px; border-top:1px solid #e0e0e0;
    background:#fff;
  }
  #msg{
    flex:1;
    font-size:15px; line-height:1.3;
    padding:10px 14px;
    border:1px solid #d0d0d0; border-radius:var(--radius);
    outline:none;
  }

  /* ───────── bubbles ───────────────────────────────────── */
  .bubble{
    max-width:78%;
    padding:10px 14px;
    border-radius:var(--radius);
    line-height:1.35;
    word-break:break-word;
    white-space:pre-wrap;
    font-size:15px;
  }

  .bot{
    background:var(--grey); color:#000;
    align-self:flex-start;
    border-bottom-left-radius:6px;      /* sharp-ish tail corner */
  }
  .user{
    background:var(--blue); color:#fff;
    align-self:flex-end;
    border-bottom-right-radius:6px;
  }

  /* links inherit bubble colour + underline on hover */
  .bubble a{ color:inherit; text-decoration:underline; }
  </style>
</head>

<body>
  <div class="chatbox">
    <div id="log"></div>

    <form id="frm">
      <input id="msg" autocomplete="off" placeholder="Ask a question…">
    </form>
  </div>

<script>
/* ───────── helpers ─────────────────────────────────────── */
const SESSION_KEY = "spectraflex_chat_session";
let session = localStorage.getItem(SESSION_KEY) || null;

function escapeHtml(str){
  return str.replace(/[&<>]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]));
}
function linkify(str){
  str = str.replace(/\[([^\]]+)]\((https?:\/\/[^\s)]+)\)/g,
                    (_,lbl,url)=>`<a href="${url}" target="_blank" rel="noopener">${lbl}</a>`);
  return str.replace(/(https?:\/\/[^\s]+)/g,
                    url=>`<a href="${url}" target="_blank" rel="noopener">${url}</a>`);
}
function addBubble(role,html){
  const div = document.createElement("div");
  div.className = `bubble ${role}`;
  div.innerHTML = html;
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
}

/* ───────── websocket setup ─────────────────────────────── */
const WS_URL = decodeURIComponent(
  new URLSearchParams(location.search).get("ws") ||
  "wss://omnichat-spectraflex.onrender.com/ws"
);

const ws  = new WebSocket(WS_URL);
const log = document.getElementById("log");

ws.onopen   = () => console.log("[WS] open →", WS_URL);
ws.onclose  = e  => console.log("[WS] closed", e.code, e.reason);
ws.onerror  = e  => console.error("[WS] error", e);

/* incoming messages ------------------------------------------------------- */
ws.onmessage = e => {
  const d = JSON.parse(e.data);           // { session, answer }

  if (d.session && !session){
    session = d.session;
    localStorage.setItem(SESSION_KEY, session);
  }
  addBubble("bot", linkify(escapeHtml(d.answer)));
};

/* ───────── send handler ────────────────────────────────── */
document.getElementById("frm").onsubmit = e => {
  e.preventDefault();
  const val = msg.value.trim();
  if (!val || ws.readyState !== WebSocket.OPEN) return;

  ws.send(JSON.stringify({
    session,
    message: val,
    product: window.__CURRENT_PRODUCT_HANDLE__ || null
  }));

  addBubble("user", linkify(escapeHtml(val)));
  msg.value = "";
};

/* autofocus on load inside the iframe */
window.onload = () => msg.focus();
</script>
</body>
</html>
